# Linux文件与权限

## 文件与权限

与`Windows`有一个很大的不同，在`Linux`中，万物皆是文件。你的代码是文件，系统的运行的进程也是文件，甚至你的键盘鼠标光驱等设备也都是文件，只不过有一些文件并不会占用你的磁盘空间。`Linux`的这种**万物皆文件**的设计哲学使得其简单而又优雅。

与文件关联最大的就是文件的权限了。`Linux`与`Windows`不同，`Windows`一般情况是都是单用户的，唯一的用户就是管理员，对文件进行权限管理是没有多大必要的。而`Linux`的设计的面向多用户的。在同一台`Linux`主机中，可能会有很多的用户同时使用，所以需要根据用户对文件进行权限管理。在`Linux`当中文件可以根据以下的三种对象进行设置，**文件拥有者**(user)，**用户组成员**(group)，**其他用户**(others)。

## 文件的权限

使用`ls -l`命令就可以查看某一个文件的权限信息。其中`l`参数就是表示列出文件的详细信息。但是更多情况下我们可以使用`ll`命令。`ll`其实是`bash shell`的一个`alias`。

```bash
# which ll
ll: aliased to ls -lh
```

多了的这个`h`的参数是将文件的参数表示成人(**h**uman)能读懂的方式，如`1K 3M`等，默认是显示字节为单位。

```bash
# ll hello.c
-rw-rw-r-- 1 sher sher 100 Sep  3 18:00 hello.c
```

-   第一栏表示文件的权限。

    >   ```
    >   [-] [rw-] [rw-] [r--]
    >   1   234   567   890
    >   ```
    >
    >   第一位表示文件的类型，有以下的这几种类型。
    >
    >   -   d：表示为目录
    >
    >   -   -：表示为文件
    >
    >   -   |：表示为链接文件
    >
    >   -   b：表示为可按块随机读写的设备
    >
    >   -   c：表示为串行端口设备，如鼠标键盘等一次性读取设备。
    >
    >   接下来三个为一组，为`rwx`的组合。
    >
    >   `rwx`分别为`read write execute`，三者的位置不会变，如果没有相应的权限就会出现`-`。
    >   
    >   -   第一组为文件拥有者所拥有的权限。从上面可以看到文件的拥有者可以查看并且修改该文件，但是无法执行该文件。
    >   
    >   -   第二组为加入该用户组的成员拥有的权限。所有`sher`用户组的成员都可以查看并且修改给文件。
    >   
    >   -   第三组为其他成员拥有的权限。其他成员只可以查看该文件，无法修改。

-   第二栏表示有多少文件名链接到此节点`(inode)`。

    在之前有关linux链接中谈及，主要和硬链接有关。

-   第三栏表示文件拥有者。

-   第四栏表示文件用户组。

-   第五栏表示文件的大小。

-   后面的三栏表示文件的创建日期或最近的修改日期。

    如果想要查看详细的信息的话，可以使用`ls -l --full-time`

-   最后一栏表示的是文件名。

    如果这是一个软链接文件的话，还会显示该软链接链接的原始文件。如`a.txt -> b.txt`。

## 文件权限的修改

文件权限的修改主要使用以下的三个命令。

-   chown：修改文件的拥有者。
-   chgrp：修改文件的用户组。
-   chmod：修改文件的权限。

`chown`和`chgrp`命令都需要`root`权限才可以执行，使用方式如下。

```bash
chown user filename 或者 chown user:groun filename
chgrp group filename
```

对文件操作的时候，可以使用`-R`参数对其中的文件进行递归的设置。

`chmod`命令主要是用来修改上面我们说的三组`rwx`的，只有文件的拥有者或者是`root`用户可以执行。

```bash
chmod u+x,go+w filename # user加上x的权限，group和others加上w的权限
chmod u=rwx,go=rx filename
chmod a-x filename # 去掉all的w权限。相当于chmod ugo-x filename
```

还有一种方式来设置权限，通过二进制。如`rwx`就是`111(7)`，`r-x`就是`101(5)`。

```bash
chmod 755 filename
```

## 目录权限的意义

对于文件和目录来说，`rwx`代表者不同的意义。对于文件的意义是非常容易理解的。需要注意的事，在`linux`当中文件是否可以执行，不是看文件的后缀名，而是看文件是否有`x`权限。但是对于目录来说，`rwx`代表的含义就大为不同了。

-   `r`代表具有读取目录结构列表的权限。

    ```bash
    $: l hello                                                        
    ls: cannot access 'hello/hello.c': Permission denied
    ls: cannot access 'hello/..': Permission denied
    ls: cannot access 'hello/.': Permission denied
    total 0
    d????????? ? ? ? ?            ? .
    d????????? ? ? ? ?            ? ..
    -????????? ? ? ? ?            ? hello.c
    ```

    可以看到仅仅具有`r`权限，我们只可以读取目录结构，不可以读取目录中文件的详细信息，如权限等。我们也无法进入该目录。

-   `w`代表具有可写入权限。

    可写入权限包括删除，重命名，移动目录中的文件（不论该文件的权限是什么），新建文件。但是仅仅拥有`w`权限也是无法做上面的操作的，我们还必须同时具有`x`权限。

-   `x`代表具有进入目录，使其称为工作目录的权限。

    目录是无法被执行的，或者说目录被执行就是进入该目录。当我们开放一个目录给别人浏览时候，至少要具有`rx`这两个权限，`w`权限是不能乱给的。

## 文件和目录的默认权限

在`linux`当中，我们创建文件或者目录的时候有一个默认的权限。

文件的默认权限为`rw-rw-rw-(666)`，目录的默认权限为`rwxrwxrwx(777)`，但是实际上我们创建的目录和文件并不是这样的权限。因为还有一个关键的`umask`。

```bash
$: umask
022
```

使用默认的权限减去`umask`的权限就可以得到正确的默认权限。(不是二进制的加减)比如上面的`022`就表示，`go-w`。此时文件的默认权限为`rw-r--r--`，目录的默认权限为`rwxr-xr-x`。

也可以通过命令修改`umask`，如`umask 002`。此时文件的默认权限变为`rw-rw-r--`，目录的默认权限变为`rwxrwxr-x`。

## 文件的隐藏属性

隐藏属性对于系统安全来说非常的重要，可以通过`chattr`配置文件的隐藏属性（需要root权限）。一般来说最重要的当属`i和a`两个属性。`i`可以让一个文件无法被修改，`a`可以让这个文件可以增加但是不能修改或者删除旧数据。添加完隐藏属性之后，只能通过`lsattr`查看。

```bash
$: chattr +i hello.c
$: ls hello.c
----i---------e----- hello.c
```

当设置隐藏属性之后，即使是`root`用户也无法违例。必须要先删除掉隐藏属性才行。

## 文件的特殊权限

当我们查看`/tmp`和`/usr/bin/passwd`的权限的时候，会发现一些奇怪的东西。

```bash
$: ls -ld /tmp; ls -l /usr/bin/passwd
drwxrwxrwt 22 root root 640 Sep  3 20:24 /tmp
-rwsr-xr-x 1 root root 63640 Jul 16 04:15 /usr/bin/passwd
```

`/tmp`的权限中出现了一个`t`，`/usr/bin/passwd`的权限中出现了一个`s`。

### SUID(Set UID)

当`s`出现在文件拥有者的`x`权限上时，被称为`SUID`特殊权限。一般`SUID`有以下的限制和功能。

-   `SUID`仅能对二进制程序生效（可以执行的）。
-   执行者对与该程序要有执行权限。
-   权限要在执行该程序过程中有效。
-   执行者将拥有该程序拥有者的权限。

如上面的`/usr/bin/passwd`可以修改`/etc/shadow`下面的密码，然后用户对于`/etc/shadow`没有任何的权限。通过执行`/usr/bin/passwd`过程中用户获取了`/usr/bin/passwd`文件拥有者（root）的权限，从而可以修改`/etc/shadow`。

### SGID(Set GID)

当`s`出现在用户组的`x`权限上时，被称为`SGID`特殊权限，和上面的`SUID`比较的类似，只不过是获取用户组的权限罢了。

除了用户二进制程序，`SGID`还可以用于目录当中。设置了`SGID`的目录具有如下的功能

-   用户对于该目录要有`r, x`权限，也就是说可以进入该目录。
-   用户在此目录中的有效用户组会变成该目录的用户组。
-   用途：如果用户具有`w`权限，那么用户创建的文件的用户组和此目录的用户组相同。

### SBIT(Sticky Bit)

当`t`出现在其他用户的`x`权限上，被称为`SBIT`特殊权限。该特殊权限只针对目录生效，`SBIT`对于目录的作用是

-   用户在目录中具有`w, x`权限，也就是具有写入的权限。
-   用户在该目录中创建文件或目录时，只有自己或者`root`有权力删除该文件。

比如上面的`/tmp`目录，任何人都可以在其中创建文件，但是只有自己或者`root`有权力删除自己创建的文件。

### 设置特殊权限

可以通过`chmod`的数字方法添加特殊权限，其中

-   `SUID`为4
-   `SGID`为2
-   `SBIT`为1

在原本的三个权限数字前面添加一个数字代表特殊权限，如

```bash
chmod 5755 filename
```

文件普通权限为`rwxr-xr-x`，特殊权限为`SUID, SBIT`，组合起来就是`rwsr-xr-o`。

如果原本文件就没有执行的权限，如

```bash
chmod 7666 filename
```

权限的结果为`rwSrwSrwT`，其中大写表示是空的权限。

除了数字法添加之外，也可以通过符号法添加。如`SUID`为`u+s`，`SGID`为`g+s`，`SBIT`为`o+t`。

如上面的`chmod 5755 filename`相当于下面的

```bash
chmod u=rwxs,g=rw,o=rwt filename
```





